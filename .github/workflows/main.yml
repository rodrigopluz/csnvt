name: 🚀 Build and Deploy CSNVT Website on GitHub Actions

on:
  push:
    branches:
      - main

env:
  FTP_SERVER: ${{ secrets.FTP_SERVER }}
  FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
  FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
  SSH_PRIVATE_KEY: ${{ secrets.JWT_SECRET }}

jobs:
  deploy:
    name: 🎉 Deploy
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18]
        package: [server, web]

    steps:
      - name: 🚚 Check out code
        uses: actions/checkout@v3

      - name: 📦 Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}

      - name: 🛠️ Install dependencies
        run: yarn install

      - name: 🚀 Build and Deploy
        run: bash packages/${{ matrix.package }}/deploy.sh
        env:
          SSH_PRIVATE_KEY: ${{ env.SSH_PRIVATE_KEY }}

      - name: 📂 Sync files to Kinghost
        uses: SamKirkland/FTP-Deploy-Action@4.3.0
        with:
          server: ${{ env.FTP_SERVER }}
          username: ${{ env.FTP_USERNAME }}
          password: ${{ env.FTP_PASSWORD }}
          server-dir: /public_html/www/app_nodejs/
