name: 🚀 Build and Deploy CSNVT Website on GitHub Actions

on:
  push:
    branches:
      - main

env:
  FTP_SERVER: ${{ secrets.FTP_SERVER }}
  FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
  FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
  SSH_PRIVATE_KEY: ${{ secrets.JWT_SECRET }}

jobs:
  build-and-deploy:
    name: 🎉 Deploy
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18]
        package: [server, web]

    steps:
      - name: 🚚 Check out code
        uses: actions/checkout@v2

      - name: 📦 Setup Node.js
        uses: actions/setup-node@v2
        with:
          node-version: ${{ matrix.node-version }}

      - name: 🛠️ Install dependencies
        run: yarn install

      - name: 🛠️ Construir o front-end
        run: yarn workspace @csnvt/web build

      - name: 🛠️ Construir o back-end
        run: yarn workspace @csnvt/server build

      - name: 🕵️ Verificar diretório de saída do front-end
        run: ls -la packages/web/dist

      - name: 🕵️ Verificar diretório de saída do back-end
        run: ls -la packages/server/dist

      - name: 📤 Fazer deploy do front-end
        run: bash packages/web/deploy.sh
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: 📤 Fazer deploy do back-end
        run: bash packages/server/deploy.sh
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: 📂 Sync files to Kinghost
        uses: SamKirkland/FTP-Deploy-Action@4.3.0
        with:
          server: ${{ env.FTP_SERVER }}
          username: ${{ env.FTP_USERNAME }}
          password: ${{ env.FTP_PASSWORD }}
          server-dir: /public_html/www/app_nodejs/
